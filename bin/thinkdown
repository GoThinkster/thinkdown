#!/usr/bin/env node
'use strict';

var http = require('http');
var staticServer = require('node-static');
var gulp = require('gulp');

var path = require('path');

var livereload = require('gulp-livereload');
var injectReload = require('gulp-inject-reload');
var wrap = require('gulp-wrap');
var tap = require('gulp-tap');
var openBrowser = require('open');

var markdown = require('gulp-markdown');
var marked = require('marked');
var naturalSort = require('gulp-natural-sort');
var gulpIgnore = require('gulp-ignore');
var concat = require('gulp-concat');
var argv = require('minimist')(process.argv.slice(2));

var customRenderer = require('../lib/custom_renderers.js');

if(argv._.length > 0 ) {
  process.chdir(argv._[0]);
}

var htmlBuffer = '';
var port = 8000;

var renderer = new marked.Renderer();
renderer.code = customRenderer.highlightCode;
renderer.link = customRenderer.addBlankToLinks;
renderer.listitem = customRenderer.addListCheckboxes;
renderer.paragraph = customRenderer.addParagraphCheckboxes;

var fileServer = new staticServer.Server(__dirname+'/../assets/');
http.createServer(function (req, res) {

  if(req.url === '/') {
    res.writeHead(200, {'Content-Type': 'text/html'});
    res.end(htmlBuffer);
  } else {
    fileServer.serve(req, res);
  }
}).listen(port);

function buildMarkdown() {
  gulp.src('*.+(md|mdown)')
    .pipe(gulpIgnore.exclude('**/README.*'))
    .pipe(naturalSort())
    .pipe(concat('index.html'))
    .pipe(markdown({
      renderer: renderer
    }))
    .pipe(wrap({
      src: __dirname+'/../assets/index.html',
    }))
    .pipe(injectReload())
    .pipe(tap(function(file, t) {
      htmlBuffer = file.contents;
    }))
    .pipe(livereload());
}

buildMarkdown();

gulp.watch('*.+(md|mdown)', function() {
  buildMarkdown();
});


openBrowser('http://localhost:'+port);
